<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Sign In - Xapo Bank</title>
  <link rel="icon" href="/xapo_logo.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/xapo_logo.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Minor overrides for better touch targets on small devices */
    input[type="email"], input[type="password"] { font-size: 1rem; }
    /* Ensure the sign-in card uses comfortable spacing on larger screens */
    @media (min-width: 768px) {
      .card { padding: 2.5rem; }
    }
  </style>
</head>
<body class="bg-black text-slate-300 min-h-screen flex items-center justify-center py-8">
  <main class="w-full max-w-md px-4">
    <section class="bg-black rounded-2xl shadow-lg card mx-auto border border-black">
      <div class="p-6 sm:p-8">
        <header class="mb-6 text-center">
          <img src="/xapo_logo.svg" alt="Xapo Bank" class="mx-auto h-10 w-auto mb-3" onerror="this.style.display='none'">
          <h1 class="text-2xl font-semibold text-slate-100">Sign in to your account</h1>
        
        </header>

        <div id="signin-error" class="hidden mb-4 text-sm text-red-400"></div>
        <form id="signin-form" class="space-y-4" autocomplete="on">
          <div>
                     <label for="email" class="block text-sm font-medium text-slate-300 mb-1">Email</label>
                     <input inputmode="email" type="email" id="email" name="email" required
                       class="block w-full rounded-lg border border-slate-600 bg-black text-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-500">
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-slate-300 mb-1">Password</label>
            <div class="relative">
              <input type="password" id="password" name="password" required
                class="block w-full rounded-lg border border-slate-600 bg-black text-slate-300 px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-slate-500">
              <button type="button" id="toggle-password" aria-label="Show password"
                 class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 text-sm p-2 rounded-md hover:bg-slate-800">
                Show
              </button>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" id="remember" class="h-4 w-4 rounded border-slate-600 bg-black">
              <span class="text-slate-300">Remember me</span>
            </label>
            <a href="#" id="forgot-link" class="text-slate-400 hover:underline">Forgot password?</a>
          </div>

          <div>
            <button type="submit" id="submit-btn" class="w-full bg-slate-600 text-slate-100 font-medium rounded-lg py-3 hover:bg-slate-700 active:scale-98">
              <span id="submit-text">Sign In</span>
              <span id="submit-loading" class="hidden">Signing in...</span>
            </button>
          </div>
        </form>

        <p class="mt-4 text-center text-sm text-slate-400">Don’t have an account? <a href="./signup.html" class="text-slate-400 hover:underline">Sign up</a></p>
      </div>
    </section>
  </main>

  <script>
    // Toggle password visibility
    const toggleBtn = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('password');
    toggleBtn.addEventListener('click', () => {
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.textContent = 'Hide';
        toggleBtn.setAttribute('aria-pressed', 'true');
      } else {
        passwordInput.type = 'password';
        toggleBtn.textContent = 'Show';
        toggleBtn.setAttribute('aria-pressed', 'false');
      }
    });

    // Forgot password flow: prompt for email and call backend
    document.getElementById('forgot-link').addEventListener('click', async (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email');
      let email = emailInput.value && emailInput.value.trim();
      if (!email) {
        email = prompt('Enter your account email to receive password reset instructions:');
        if (!email) return;
      }
      try {
        const res = await fetch('/api/auth/forgot', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        alert(data.message || "If that email exists, we've sent instructions");
      } catch (err) {
        console.error(err);
        alert('Unable to send reset email — try again later');
      }
    });

    // Handle submit with loading state
    document.getElementById('signin-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitLoading = document.getElementById('submit-loading');

      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');
      submitBtn.disabled = true;

      const formData = {
        email: document.getElementById('email').value,
        password: document.getElementById('password').value
      };

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });
        let data;
        try { data = await response.json(); } catch (e) { data = null; }
        if (response.ok) {
          localStorage.setItem('token', data && data.token ? data.token : '');
          try { if (data && data.data) localStorage.setItem('user', JSON.stringify(data.data)); } catch (e) { console.warn('Could not store user', e); }
          window.location.href = '/';
        } else {
          const msg = (data && (data.message || data.error)) ? (data.message || data.error) : (response.statusText || `Sign-in failed (${response.status})`);
          const errDiv = document.getElementById('signin-error');
          if (errDiv) {
            errDiv.textContent = msg;
            errDiv.classList.remove('hidden');
          } else {
            alert(msg);
          }
        }
      } catch (err) {
        console.error(err);
        alert('Network error — please try again.');
      } finally {
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
