<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Sign In - Xapo Bank</title>
  <link rel="icon" href="/xapo_logo.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/xapo_logo.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Minor overrides for better touch targets on small devices */
    input[type="email"], input[type="password"] { font-size: 1rem; }
    /* Ensure the sign-in card uses comfortable spacing on larger screens */
    @media (min-width: 768px) {
      .card { padding: 2.5rem; }
    }
    /* Toast notifications (centered, responsive) */
    #toast-container { position: fixed; left: 50%; top: 12%; transform: translateX(-50%); z-index: 9999; display:flex; flex-direction:column; gap:0.5rem; align-items:center; width: 100%; pointer-events: none; }
    #toast-container .toast { pointer-events: auto; max-width: 90vw; width: auto; }
    .toast { background: rgba(30,30,30,0.95); color: #e6e6e6; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.4); min-width: 220px; max-width: 420px; font-size:0.95rem; display:flex; align-items:center; justify-content:space-between; gap:0.5rem; box-sizing:border-box; }
    .toast.info { border-left: 4px solid #0ea5e9; }
    .toast.success { border-left: 4px solid #10b981; }
    .toast.error { border-left: 4px solid #ef4444; }
    .toast .toast-actions { margin-left: 0.5rem; display:flex; gap:0.5rem; }
    .toast .btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .toast .btn.primary { background:#0ea5e9; color:#051124; border:none; }
  </style>
</head>
<body class="bg-black text-slate-300 min-h-screen flex items-center justify-center py-8">
  <main class="w-full max-w-md px-4">
    <section class="bg-black rounded-2xl shadow-lg card mx-auto border border-black">
      <div class="p-6 sm:p-8">
        <header class="mb-6 text-center">
          <img src="/xapo_logo.svg" alt="Xapo Bank" class="mx-auto h-10 w-auto mb-3" onerror="this.style.display='none'">
          <h1 class="text-2xl font-semibold text-slate-100">Sign in to your account</h1>
        
        </header>

        <div id="signin-error" class="hidden mb-4 text-sm text-red-400"></div>
        <form id="signin-form" class="space-y-4" autocomplete="on">
          <div>
                     <label for="email" class="block text-sm font-medium text-slate-300 mb-1">Email</label>
                     <input inputmode="email" type="email" id="email" name="email" required
                       class="block w-full rounded-lg border border-slate-600 bg-black text-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-500">
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-slate-300 mb-1">Password</label>
            <div class="relative">
              <input type="password" id="password" name="password" required
                class="block w-full rounded-lg border border-slate-600 bg-black text-slate-300 px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-slate-500">
              <button type="button" id="toggle-password" aria-label="Show password"
                 class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 text-sm p-2 rounded-md hover:bg-slate-800">
                Show
              </button>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" id="remember" class="h-4 w-4 rounded border-slate-600 bg-black">
              <span class="text-slate-300">Remember me</span>
            </label>
            <a href="#" id="forgot-link" class="text-slate-400 hover:underline">Forgot password?</a>
          </div>

          <div>
            <button type="submit" id="submit-btn" class="w-full bg-slate-600 text-slate-100 font-medium rounded-lg py-3 hover:bg-slate-700 active:scale-98">
              <span id="submit-text">Sign In</span>
              <span id="submit-loading" class="hidden">Signing in...</span>
            </button>
          </div>
        </form>

        <p class="mt-4 text-center text-sm text-slate-400">Don’t have an account? <a href="./signup.html" class="text-slate-400 hover:underline">Sign up</a></p>
      </div>
    </section>
  </main>

  <script>
    // Register service worker to proxy /api/* from static site to backend.
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(reg => {
        console.debug('Service worker registered', reg);
        // Send API base to the worker when active
        const sendApiBase = (worker) => {
          try { worker.postMessage({ type: 'setApiBase', value: window.API_BASE || window.API_URL || 'https://xa-poloan.onrender.com' }); } catch (e) {}
        };
        if (reg.installing) reg.installing.addEventListener('statechange', () => {});
        if (reg.waiting) sendApiBase(reg.waiting);
        if (reg.active) sendApiBase(reg.active);
      }).catch(err => console.warn('Service worker registration failed', err));
    }

    // tryFetch: attempt same-origin first, fall back to explicit backend URL
    async function tryFetch(path, opts){
      const API_BASE = (window.API_BASE || window.API_URL || '').replace(/\/$/, '');
      const origin = location.origin.replace(/\/$/, '');
      // Prefer an explicit API_BASE when provided (static site -> backend).
      // Fall back to same-origin requests if API_BASE is not set or the
      // primary attempt fails with a network error.
      const candidates = [];
      if (API_BASE) candidates.push(API_BASE + path);
      // always try same-origin as a fallback
      candidates.push(path);

      let lastErr = null;
      for (const url of candidates) {
        try {
          return await fetch(url, opts);
        } catch (e) {
          lastErr = e;
          // try next candidate
        }
      }
      // If no candidate succeeded, throw the last network error
      throw lastErr || new Error('fetch failed');
    }
    // Toggle password visibility
    const toggleBtn = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('password');
    toggleBtn.addEventListener('click', () => {
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.textContent = 'Hide';
        toggleBtn.setAttribute('aria-pressed', 'true');
      } else {
        passwordInput.type = 'password';
        toggleBtn.textContent = 'Show';
        toggleBtn.setAttribute('aria-pressed', 'false');
      }
    });

    // Lightweight non-blocking toast UI
    (function(){
      const container = document.createElement('div');
      container.id = 'toast-container';
      document.body.appendChild(container);

      window.showToast = function(message, opts = {}) {
        const { type = 'info', duration = 4000, actions = [] } = opts;
        return new Promise((resolve) => {
              const t = document.createElement('div');
              t.className = `toast ${type}`;
              const text = document.createElement('div');
              text.style.flex = '1';
              text.textContent = message;
              t.appendChild(text);
              const actionsWrap = document.createElement('div');
              actionsWrap.className = 'toast-actions';
              if (Array.isArray(actions) && actions.length) {
                actions.forEach(a => {
                  const btn = document.createElement('button');
                  btn.className = 'btn' + (a.primary ? ' primary' : '');
                  btn.textContent = a.text || 'OK';
                  btn.addEventListener('click', () => {
                    clear();
                    resolve(a.value || a.text || 'action');
                  });
                  actionsWrap.appendChild(btn);
                });
                t.appendChild(actionsWrap);
              }
              // close control
              const closeBtn = document.createElement('button');
              closeBtn.className = 'btn';
              closeBtn.textContent = '×';
              closeBtn.title = 'Close';
              closeBtn.style.marginLeft = '8px';
              closeBtn.addEventListener('click', () => { clear(); resolve('closed'); });
              t.appendChild(closeBtn);

          let timeout = null;
          function clear() {
            if (timeout) clearTimeout(timeout);
            try { t.remove(); } catch (e) {}
          }

          container.appendChild(t);
          if (!actions.length) {
            timeout = setTimeout(() => { clear(); resolve('timeout'); }, duration);
          }
        });
      };
    })();

    // Forgot password flow: non-blocking confirmation via toast
    document.getElementById('forgot-link').addEventListener('click', async (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email');
      let email = (emailInput.value && emailInput.value.trim()) || '';
      if (!email) {
        email = prompt('Enter your registered account email to receive password reset instructions:');
        if (!email) return;
      }

      const choice = await window.showToast(`Send password reset instructions to ${email}?`, { type: 'info', duration: 0, actions: [ { text: 'Cancel', value: 'cancel' }, { text: 'Send', value: 'send', primary: true } ] });
      if (choice !== 'send') return;

      try {
        const res = await tryFetch('/api/auth/forgot', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        if (res && res.ok) {
          await window.showToast('Password reset instructions have been sent to your registered email address. Please check your inbox.', { type: 'success', duration: 5000 });
        } else {
          await window.showToast('If that email is registered with us, you will receive password reset instructions shortly.', { type: 'info', duration: 5000 });
        }
      } catch (err) {
        console.error(err);
        await window.showToast('Unable to send reset email — try again later', { type: 'error', duration: 5000 });
      }
    });

    // Handle submit with loading state
    document.getElementById('signin-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitLoading = document.getElementById('submit-loading');

      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');
      submitBtn.disabled = true;

      const formData = {
        email: document.getElementById('email').value,
        password: document.getElementById('password').value
      };

      try {
        const response = await tryFetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });
        let data;
        let rawText = null;
        try {
          data = await response.json();
        } catch (e) {
          // If server returned non-JSON, attempt to read the text and parse as JSON
          try {
            const txt = await response.text();
            const txtStripped = txt.replace(/^\uFEFF/, '').trim();
            rawText = txtStripped;
            try {
              data = JSON.parse(txtStripped);
              console.warn('Parsed JSON from non-standard response body', data);
            } catch (parseErr) {
              console.warn('Login response not JSON:', txtStripped);
              data = null;
            }
          } catch (_) {
            data = null;
          }
        }
        console.debug('Login response:', { status: response.status, ok: response.ok, body: data });
        if (response.ok) {
          const tokenVal = data && data.token ? data.token : '';
          if (!tokenVal) {
            const msg = 'Login succeeded but server did not return a token.';
            console.warn(msg, data, rawText);
            const errDiv = document.getElementById('signin-error');
            if (errDiv) {
              errDiv.textContent = rawText ? `${msg} — ${rawText}` : msg;
              errDiv.classList.remove('hidden');
            } else {
              alert(rawText ? `${msg} — ${rawText}` : msg);
            }
            try { if (data && data.data) localStorage.setItem('user', JSON.stringify(data.data)); } catch (e) { console.warn('Could not store user', e); }
            // Do not redirect — waiting for token from server
          } else {
            console.debug('Received token from server (redacted):', typeof tokenVal === 'string' ? '[REDACTED]' : tokenVal);
            // Attempt to persist token in localStorage, fall back to cookie if storage is blocked
            try {
              localStorage.setItem('token', tokenVal);
            } catch (err) {
              console.warn('localStorage.setItem failed — falling back to cookie', err && err.message ? err.message : err);
              try {
                // set a conservative path so client scripts on the site can read it
                document.cookie = 'token=' + encodeURIComponent(tokenVal) + '; path=/; max-age=' + (7 * 24 * 60 * 60);
              } catch (e) {
                console.warn('Cookie fallback failed', e && e.message ? e.message : e);
              }
            }
            try { if (data && data.data) localStorage.setItem('user', JSON.stringify(data.data)); } catch (e) { console.warn('Could not store user', e); }
            console.debug('Token persisted (storage fallback attempted), redirecting to /');
            window.location.href = '/';
          }
        } else {
          const msg = (data && (data.message || data.error)) ? (data.message || data.error) : (response.statusText || `Sign-in failed (${response.status})`);
          const errDiv = document.getElementById('signin-error');
          if (errDiv) {
            errDiv.textContent = msg;
            errDiv.classList.remove('hidden');
          } else {
            alert(msg);
          }
        }
      } catch (err) {
        console.error(err);
        alert('Network error — please try again.');
      } finally {
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
